<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HRD Rewards</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body{background:#f1f5f9}</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useMemo } = React;
  const fmt = new Intl.NumberFormat('th-TH');

  // ======= CONFIG =======
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwQOySMrUN6H-6Yg8CnbMRWA8zFDIcS-v2hwjHGuM8tJaydDbDr79lvaUEXXFOiV8rRUA/exec'; // /exec ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

  async function callApi(action, payload) {
    const res = await fetch(WEBAPP_URL, {
      method: 'POST',
      body: JSON.stringify({ action, payload }), // ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô text/plain
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { return { ok:false, message:'Bad JSON from server', raw:text }; }
  }

  // API ‡πÅ‡∏¢‡∏Å‡∏¢‡πà‡∏≠‡∏¢
  const api = {
    login:(u,p)=>callApi('login',{username:u,password:p}),
    getPoints:(id)=>callApi('getPoints',{employeeId:id}),
    redeem:(id,amt,note)=>callApi('redeem',{employeeId:id,amount:amt,note}),
    checkEmployee:(id)=>callApi('checkEmployee',{employeeId:id}),
    register:(pl)=>callApi('register',pl),
    forgot:(id,email)=>callApi('forgot',{employeeId:id,email}),
    resetPassword:(pl)=>callApi('resetPassword',pl),
    getAnnouncements:()=>callApi('getAnnouncements',{}),
    getRules:()=>callApi('getRules',{}),
    adminSaveConfig:(pl)=>callApi('adminSaveConfig',pl),
  };

  // ========= Reusable =========
  function PasswordInput({ value, onChange, placeholder="password" }) {
    const [show,setShow] = useState(false);
    return (
      <div className="relative">
        <input type={show?'text':'password'} value={value} onChange={onChange}
               placeholder={placeholder} autoComplete="new-password"
               className="w-full border rounded-xl px-3 py-2 pr-10" />
        <button type="button" onClick={()=>setShow(!show)}
          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500">
          {show ? 'üôà' : 'üëÅÔ∏è'}
        </button>
      </div>
    );
  }

  // ========= Auth =========
  function Login({ onOK, onOpenRegister, onOpenForgot, onOpenReset }) {
    const [u,setU]=useState(''), [p,setP]=useState('');
    const [err,setErr]=useState(''), [busy,setBusy]=useState(false);
    const submit = async(e)=>{
      e.preventDefault(); setErr(''); setBusy(true);
      try{
        const r = await api.login(u.trim(), p.trim());
        if(!r.ok) throw new Error(r.message||'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        onOK(r.user, r.history||[]);
      }catch(ex){ setErr(String(ex.message||ex)); } finally{ setBusy(false); }
    };
    return (
      <div className="min-h-screen grid place-items-center px-4">
        <form onSubmit={submit} className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="flex items-center gap-2 mb-3">
            <div className="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center">SF</div>
            <div className="font-semibold">HRD Rewards</div>
          </div>
          <div className="text-sm text-slate-500 mb-3">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ <b>username</b> / <b>password</b> ‡∏à‡∏≤‡∏Å Sheet1 (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå I,J)
          </div>
          <div className="space-y-3">
            <div>
              <label className="text-xs text-slate-500">username</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" autoComplete="off"
                     value={u} onChange={e=>setU(e.target.value)} />
            </div>
            <div>
              <label className="text-xs text-slate-500">password</label>
              <div className="mt-1"><PasswordInput value={p} onChange={e=>setP(e.target.value)} /></div>
            </div>
            {err && <div className="text-sm text-rose-600">{err}</div>}
            <button className="w-full rounded-xl bg-slate-900 text-white py-2 disabled:opacity-50" disabled={busy}>
              {busy? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
            </button>
            <div className="text-sm text-center text-slate-600">
              <button type="button" className="underline mr-3" onClick={onOpenRegister}>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
              <button type="button" className="underline mr-3" onClick={onOpenForgot}>‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
              <button type="button" className="underline" onClick={onOpenReset}>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
            </div>
          </div>
        </form>
      </div>
    );
  }

  function Register({ onDone }) {
    const initial = { employeeId:'', title:'', name:'', dob:'', email:'', username:'', password:'', password2:'' };
    const [step,setStep]=useState(1), [form,setForm]=useState(initial);
    const [exists,setExists]=useState(null);
    const [msg,setMsg]=useState(''), [err,setErr]=useState(''), [busy,setBusy]=useState(false);

    const check = async()=>{
      setErr('');
      if(!form.employeeId.trim()) return setErr('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
      const r = await api.checkEmployee(form.employeeId.trim());
      if(!r.ok) return setErr(r.message||'‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      setExists(r);
      setStep(2);
    };

    const submit = async()=>{
      setErr(''); setMsg(''); setBusy(true);
      try{
        if(!form.username || !form.password || (form.password!==form.password2)) {
          throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å username ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
        }
        const r = await api.register(form);
        if(!r.ok) throw new Error(r.message||'‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setMsg('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
        setTimeout(onDone, 1200); // ‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö
      }catch(ex){ setErr(String(ex.message||ex)); } finally{ setBusy(false); }
    };

    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-lg bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>

          {step===1 ? (
            <div className="space-y-3">
              <div>
                <label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1"
                       value={form.employeeId}
                       onChange={e=>setForm(f=>({...f,employeeId:e.target.value}))}/>
              </div>
              {err && <div className="text-sm text-rose-600">{err}</div>}
              <div className="flex gap-2">
                <button onClick={check} disabled={busy}
                        className="rounded-xl bg-violet-600 text-white px-4 py-2">
                  {busy? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Ä¶' : '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'}
                </button>
                <button onClick={onDone} type="button" className="rounded-xl border px-4 py-2">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
              </div>
            </div>
          ) : (
            <div className="space-y-3">
              {exists?.exists ? (
                <div className="p-3 bg-emerald-50 rounded-lg text-sm">
                  ‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <b>{exists.name||form.employeeId}</b><br/>‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á username / password ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                </div>
              ) : (
                <div className="p-3 bg-amber-50 rounded-lg text-sm">
                  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á username / password
                </div>
              )}

              <div className="text-right -mt-2 mb-1">
                <button className="text-xs underline" onClick={()=>{ setStep(1); setErr(''); setMsg(''); }}>
                  ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                </button>
              </div>

              {!exists?.exists && (
                <>
                  <div>
                    <label className="text-xs text-slate-500">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1"
                      value={form.title} onChange={e=>setForm(f=>({...f,title:e.target.value}))}/>
                  </div>
                  <div>
                    <label className="text-xs text-slate-500">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1"
                      value={form.name} onChange={e=>setForm(f=>({...f,name:e.target.value}))}/>
                  </div>
                  <div>
                    <label className="text-xs text-slate-500">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (yyyy-mm-dd)</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1" placeholder="1990-01-31"
                      value={form.dob} onChange={e=>setForm(f=>({...f,dob:e.target.value}))}/>
                  </div>
                </>
              )}

              <div>
                <label className="text-xs text-slate-500">Email *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1"
                  value={form.email} onChange={e=>setForm(f=>({...f,email:e.target.value}))}/>
              </div>
              <div>
                <label className="text-xs text-slate-500">‡∏ï‡∏±‡πâ‡∏á username *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1"
                  value={form.username} onChange={e=>setForm(f=>({...f,username:e.target.value}))}/>
              </div>
              <div>
                <label className="text-xs text-slate-500">‡∏ï‡∏±‡πâ‡∏á password *</label>
                <div className="mt-1"><PasswordInput value={form.password} onChange={e=>setForm(f=>({...f,password:e.target.value}))}/></div>
              </div>
              <div>
                <label className="text-xs text-slate-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô password *</label>
                <div className="mt-1"><PasswordInput value={form.password2} onChange={e=>setForm(f=>({...f,password2:e.target.value}))}/></div>
              </div>

              {err && <div className="text-sm text-rose-600">{err}</div>}
              {msg && <div className="text-sm text-emerald-600">{msg}</div>}

              <div className="flex gap-2">
                <button onClick={submit} disabled={busy} className="rounded-xl bg-violet-600 text-white px-4 py-2">
                  {busy? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‚Ä¶' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}
                </button>
                <button onClick={onDone} type="button" className="rounded-xl border px-4 py-2">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  function Forgot({ onDone }) {
    const [emp,setEmp]=useState(''), [email,setEmail]=useState('');
    const [msg,setMsg]=useState(''), [err,setErr]=useState(''), [busy,setBusy]=useState(false);
    const submit = async()=>{
      setErr(''); setMsg(''); setBusy(true);
      try{
        const r = await api.forgot(emp.trim(), email.trim());
        if(!r.ok) throw new Error(r.message||'‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setMsg('‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß / ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡πÅ‡∏õ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° HRD');
        setTimeout(onDone, 1200); // ‚úÖ ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö Login
      }catch(ex){ setErr(String(ex.message||ex)); } finally{ setBusy(false); }
    };
    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
          <div className="space-y-3">
            <div>
              <label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={emp} onChange={e=>setEmp(e.target.value)} />
            </div>
            <div>
              <label className="text-xs text-slate-500">Email (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå H)</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={email} onChange={e=>setEmail(e.target.value)} />
            </div>
            {err && <div className="text-sm text-rose-600">{err}</div>}
            {msg && <div className="text-sm text-emerald-600">{msg}</div>}
            <div className="flex gap-2">
              <button className="rounded-xl bg-slate-900 text-white px-4 py-2" onClick={submit} disabled={busy}>
                {busy?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...':'‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠'}
              </button>
              <button className="rounded-xl border px-4 py-2" onClick={onDone}>‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  function ResetPassword({ onDone }) {
    const [employeeId,setEmp]=useState('');
    const [username,setU]=useState('');
    const [temp,setTemp]=useState('');
    const [new1,setN1]=useState(''), [new2,setN2]=useState('');
    const [err,setErr]=useState(''), [msg,setMsg]=useState('');
    const submit = async()=>{
      setErr(''); setMsg('');
      try{
        if(!employeeId || !username || !temp) throw new Error('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        if(new1!==new2 || !new1) throw new Error('‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
        const r = await api.resetPassword({ employeeId, username, tempPassword:temp, newPassword:new1 });
        if(!r.ok) throw new Error(r.message||'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setMsg('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
        setTimeout(onDone, 1200); // ‚úÖ ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö
      }catch(ex){ setErr(String(ex.message||ex)); }
    };
    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
          <div className="space-y-3">
            <div>
              <label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={employeeId} onChange={e=>setEmp(e.target.value)}/>
            </div>
            <div>
              <label className="text-xs text-slate-500">Username</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={username} onChange={e=>setU(e.target.value)}/>
            </div>
            <div>
              <label className="text-xs text-slate-500">Password ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•)</label>
              <PasswordInput value={temp} onChange={e=>setTemp(e.target.value)}/>
            </div>
            <div>
              <label className="text-xs text-slate-500">Password ‡πÉ‡∏´‡∏°‡πà</label>
              <PasswordInput value={new1} onChange={e=>setN1(e.target.value)}/>
            </div>
            <div>
              <label className="text-xs text-slate-500">Password ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</label>
              <PasswordInput value={new2} onChange={e=>setN2(e.target.value)}/>
            </div>
            {err && <div className="text-sm text-rose-600">{err}</div>}
            {msg && <div className="text-sm text-emerald-600">{msg}</div>}
            <div className="flex gap-2">
              <button className="rounded-xl bg-slate-900 text-white px-4 py-2" onClick={submit}>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
              <button className="rounded-xl border px-4 py-2" onClick={onDone}>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // ========= Demo Items =========
  const ITEMS = [
    { id:"R002", name:"‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∑‡∏î SF Sport Club", points:700, stock:24, img:"üëï" },
    { id:"R003", name:"‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏ã‡πá‡∏ï 3 ‡∏ú‡∏∑‡∏ô",   points:550, stock:42, img:"üßº" },
    { id:"R008", name:"‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏¥‡∏á‡∏õ‡∏≠‡∏á (‡πÑ‡∏°‡πâ+‡∏•‡∏π‡∏Å)",  points:900, stock:10, img:"üèì" },
    { id:"R011", name:"‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏™‡πÅ‡∏ï‡∏ô‡πÄ‡∏•‡∏™ 20oz",   points:600, stock:30, img:"ü•§" },
    { id:"R012", name:"‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏õ‡πÇ‡∏• SF (Limited)", points:1100,stock:15, img:"üß•" },
    { id:"R013", name:"‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ SF",            points:400, stock:40, img:"üß¢" },
    { id:"R014", name:"‡∏ñ‡∏∏‡∏á‡∏ú‡πâ‡∏≤‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° + ‡πÄ‡∏Ç‡πá‡∏°‡∏Å‡∏•‡∏±‡∏î", points:450, stock:50, img:"üëú" },
  ];

  function Header({ user, cartCount, onLogout, openCart, tab, setTab }) {
    return (
      <header className="bg-white border-b">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center">SF</div>
            <div className="leading-tight">
              <div className="font-semibold">HRD Rewards</div>
              <div className="text-xs text-slate-500">Wellness & Happy Workplace</div>
            </div>
          </div>
          <nav className="hidden md:flex items-center gap-2">
            {[
              {id:'home', label:'‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å'},
              {id:'catalog', label:'‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á'},
              {id:'me', label:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô'},
              {id:'history', label:'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥'},
              {id:'news', label:'‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®/‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤'},
              ...(user?.role==='admin' ? [{id:'admin',label:'Admin'}] : []),
            ].map(m=>(
              <button key={m.id}
                onClick={()=>setTab(m.id)}
                className={"px-3 py-1.5 rounded-xl text-sm border "+(tab===m.id?'bg-slate-900 text-white border-slate-900':'bg-white hover:bg-slate-50')}>
                {m.label}
              </button>
            ))}
          </nav>
          <div className="flex items-center gap-2">
            <div className="hidden sm:block text-right mr-2">
              <div className="text-sm font-medium">{user.name}</div>
              <div className="text-xs text-slate-500">{user.id}</div>
            </div>
            <button onClick={openCart} className="relative rounded-xl border px-3 py-1.5 text-sm bg-slate-50">
              üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤{cartCount? <span className="ml-1">({cartCount})</span> : null}
            </button>
            <button onClick={onLogout} className="rounded-xl border px-3 py-1.5 text-sm bg-slate-50">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
        </div>
      </header>
    );
  }

  function CheckoutModal({ open, onClose, user, cart, setItems, setUser }) {
    if(!open) return null;
    const total = cart.reduce((s,c)=> s + c.points*c.qty, 0);
    const doCheckout = async ()=>{
      try{
        const note = cart.map(c=>`${c.name} x${c.qty}`).join(', ');
        const r = await api.redeem(user.id, total, note);
        if(!r.ok) throw new Error(r.message||'‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        const fresh = await api.getPoints(user.id);
        if (fresh.ok) setUser(u=>({...u, points:fresh.points}));
      }catch(ex){
        alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πâ‡∏°: '+ex);
        return;
      }
      setItems(prev=> prev.map(it=>{
        const c = cart.find(x=>x.id===it.id);
        if(!c) return it;
        return {...it, stock: Math.max(0, it.stock - c.qty)};
      }));
      onClose(true); // ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    };
    return (
      <div className="fixed inset-0 z-30 bg-black/40 grid place-items-center p-4">
        <div className="w-full max-w-2xl bg-white rounded-2xl shadow-lg">
          <div className="flex items-center justify-between p-4 border-b">
            <div className="font-semibold">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</div>
            <button onClick={()=>onClose(false)} className="rounded-full w-8 h-8 grid place-items-center border">‚úï</button>
          </div>
          <div className="p-4 max-h-[60vh] overflow-auto">
            {cart.length===0 ? <div className="text-center text-slate-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div> :
              <ul className="space-y-3">
                {cart.map(c=>(
                  <li key={c.id} className="flex items-center gap-3 border rounded-xl p-3">
                    <div className="text-2xl">{c.img}</div>
                    <div className="flex-1">
                      <div className="font-medium">{c.name}</div>
                      <div className="text-xs text-slate-500">{c.points} pts</div>
                    </div>
                    <div className="w-24 text-right font-semibold">{fmt.format(c.points*c.qty)} pts</div>
                  </li>
                ))}
              </ul>
            }
          </div>
          <div className="p-4 border-t flex items-center justify-between">
            <div className="text-sm text-slate-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏∏‡∏ì: <b>{fmt.format(user.points)} pts</b></div>
            <div className="text-right">
              <div className="text-sm">‡∏£‡∏ß‡∏°‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</div>
              <div className="text-xl font-bold">{fmt.format(total)} pts</div>
            </div>
          </div>
          <div className="p-4 border-t text-right">
            <button className="rounded-xl px-4 py-2 bg-slate-900 text-white disabled:opacity-50"
                    disabled={cart.length===0 || total>user.points}
                    onClick={doCheckout}>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å</button>
          </div>
        </div>
      </div>
    );
  }

  function NewsPage(){
    const [announce,setAnn]=useState([]);
    const [rules,setRules]=useState([]);
    useEffect(()=>{
      (async()=>{
        const A = await api.getAnnouncements(); if(A.ok) setAnn(A.items||[]);
        const R = await api.getRules(); if(R.ok) setRules(R.items||[]);
      })();
    },[]);
    return (
      <div className="space-y-4">
        <section className="bg-white rounded-2xl shadow p-4">
          <div className="font-semibold mb-3">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          {announce.length===0 ? <div className="text-sm text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</div> :
            <div className="space-y-3">
              {announce.map((a,i)=>(
                <div key={i} className="border rounded-xl p-3">
                  <div className="flex items-start gap-3">
                    <div className="text-xl">üì£</div>
                    <div className="flex-1">
                      <div className="font-medium">{a.title}</div>
                      <div className="text-sm text-slate-600">{a.body}</div>
                      <div className="text-xs text-slate-400 mt-1">{a.ts||''}</div>
                      {a.img ? <img src={a.img} alt="" className="mt-2 max-h-40 rounded-lg" /> : null}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          }
        </section>

        <section className="bg-white rounded-2xl shadow p-4">
          <div className="font-semibold mb-3">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
          <div className="space-y-2">
            {rules.map((r,i)=>(
              <div key={i} className="border rounded-xl p-3">
                <div className="font-medium">{r.title}</div>
                <div className="text-sm text-slate-600">{r.body}</div>
              </div>
            ))}
          </div>
        </section>

        <section className="bg-white rounded-2xl shadow p-4">
          <div className="font-semibold mb-3">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
          <div className="grid md:grid-cols-2 gap-3 text-sm text-slate-700">
            <div className="border rounded-xl p-3">
              <div className="font-medium mb-1">‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
              <div>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πâ‡∏°</div>
            </div>
            <div className="border rounded-xl p-3">
              <div className="font-medium mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</div>
              <div>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 09:00 ‡∏ô. ‡πÅ‡∏•‡∏∞ 18:00 ‡∏ô.</div>
            </div>
            <div className="border rounded-xl p-3">
              <div className="font-medium mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</div>
              <div>‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡πÄ‡∏ß‡∏•‡∏≤ 08:00 - 17:00 ‡∏ô. (‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå)</div>
            </div>
            <div className="border rounded-xl p-3">
              <div className="font-medium mb-1">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°</div>
              <div>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏à 3CX : 2058</div>
            </div>
          </div>
        </section>
      </div>
    );
  }

  function App(){
    const [mode,setMode] = useState('login'); // login | register | forgot | reset | app
    const [user,setUser]=useState(null);
    const [tab,setTab]=useState('home'); // home | catalog | me | history | news | admin
    const [items,setItems]=useState(ITEMS);
    const [cart,setCart]=useState([]);
    const [openCart,setOpenCart]=useState(false);

    // Mock ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ (home/me/history/admin) ‡πÉ‡∏ä‡πâ UI ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° placeholder
    const Home = () => (
      <div className="bg-white rounded-2xl shadow p-4">
        <div className="font-semibold">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, {user.name}</div>
        <div className="text-sm text-slate-600 mt-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>{fmt.format(user.points)} pts</b></div>
      </div>
    );

    const Catalog = () => (
      <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
        {items.map(r=>(
          <div key={r.id} className="rounded-2xl border p-4 flex flex-col">
            <div className="flex items-center gap-3">
              <div className="text-3xl">{r.img}</div>
              <div className="flex-1">
                <div className="font-medium">{r.name}</div>
                <div className="text-xs text-slate-500 mt-1 flex gap-2">
                  <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs">{r.points} pts</span>
                  <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs">‡∏™‡∏ï‡πá‡∏≠‡∏Å {r.stock}</span>
                </div>
              </div>
            </div>
            <button onClick={()=>{
              setCart(prev=>{
                const has = prev.find(x=>x.id===r.id);
                if(has) return prev.map(x=> x.id===r.id ? {...x, qty:Math.min(x.qty+1, r.stock)} : x);
                return [...prev, {...r, qty:1}];
              });
            }} disabled={r.stock<=0}
            className="mt-3 rounded-xl px-3 py-2 text-sm bg-slate-900 text-white disabled:opacity-40">
              {r.stock>0? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤' : '‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'}
            </button>
          </div>
        ))}
      </div>
    );

    const Me = () => (
      <div className="bg-white rounded-2xl shadow p-4">
        <div className="font-semibold mb-2">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
        <div className="text-sm text-slate-700">‡∏£‡∏´‡∏±‡∏™: {user.id} ‚Ä¢ ‡∏ä‡∏∑‡πà‡∏≠: {user.name}</div>
        <div className="text-sm text-slate-700">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {fmt.format(user.points)} pts</div>
      </div>
    );

    const History = () => (
      <div className="bg-white rounded-2xl shadow p-4 text-sm text-slate-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö/‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏° (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)</div>
    );

    const Admin = () => (
      <div className="bg-white rounded-2xl shadow p-4">
        <div className="font-semibold mb-2">Admin Panel</div>
        <div className="text-sm text-slate-600">‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ role: admin</div>
      </div>
    );

    if(mode==='login') return (
      <Login
        onOK={(u)=>{ setUser(u); setMode('app'); }}
        onOpenRegister={()=>setMode('register')}
        onOpenForgot={()=>setMode('forgot')}
        onOpenReset={()=>setMode('reset')}
      />
    );
    if(mode==='register') return <Register onDone={()=>setMode('login')} />;
    if(mode==='forgot')   return <Forgot onDone={()=>setMode('login')} />;
    if(mode==='reset')    return <ResetPassword onDone={()=>setMode('login')} />;

    return (
      <div>
        <Header
          user={user}
          cartCount={cart.reduce((s,c)=>s+c.qty,0)}
          onLogout={()=>{ setMode('login'); setUser(null); setCart([]); }}
          openCart={()=>setOpenCart(true)}
          tab={tab}
          setTab={setTab}
        />

        <main className="max-w-6xl mx-auto px-4 py-6">
          {tab==='home' && <Home/>}
          {tab==='catalog' && <Catalog/>}
          {tab==='me' && <Me/>}
          {tab==='history' && <History/>}
          {tab==='news' && <NewsPage/>}
          {tab==='admin' && (user.role==='admin' ? <Admin/> : <div className="text-sm text-rose-600">‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</div>)}
        </main>

        <CheckoutModal open={openCart} onClose={(ok)=>{ setOpenCart(false); if(ok) setCart([]); }}
          user={user} cart={cart} setItems={setItems} setUser={setUser} />
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
  </script>
</body>
</html>
