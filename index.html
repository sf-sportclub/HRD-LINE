<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HRD Rewards</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html,body{background:#f5f7fb}
    .chip{ @apply inline-flex items-center rounded-full border px-2 py-0.5 text-xs border-slate-300 text-slate-700; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useMemo } = React;
  const fmt = new Intl.NumberFormat('th-TH');

  /* ====== URL Apps Script (‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ====== */
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxDGSsPsIgyXhQZ4EuHdfshDQyMRK_DfNKSswtRjrMnM98lV_aVE_H6i9Na6vlNbmVC1w/exec';

  /* ====== fetch ‡πÅ‡∏ö‡∏ö simple request ====== */
  async function callApi(action, payload){
    const res = await fetch(WEBAPP_URL, { method:'POST', body: JSON.stringify({ action, payload }) });
    const text = await res.text();
    try{ return JSON.parse(text); }catch{ return { ok:false, message:'Bad JSON', raw:text }; }
  }

  // ---- API adapters ----
  const apiLogin      = (u,p)             => callApi('login',        { username:u, password:p });
  const apiGetPoints  = (id)              => callApi('getPoints',    { employeeId:id });
  const apiRedeem     = (id,amt,note)     => callApi('redeem',       { employeeId:id, amount:amt, note });
  const apiCheckEmp   = (id)              => callApi('checkEmployee',{ employeeId:id });
  const apiRegister   = (pl)              => callApi('register',     pl);
  const apiForgot     = (id,email)        => callApi('forgot',       { employeeId:id, email });
  const apiChangePass = (id,u,oldp,newp)  => callApi('changePassword',{ employeeId:id, username:u, oldPassword:oldp, newPassword:newp });
  const apiSaveConfig = (cfg)             => callApi('adminSaveConfig', cfg); // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏£‡∏¥‡∏á

  /* ====== Components ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ====== */
  const Badge = ({children}) => <span className="chip">{children}</span>;
  function PasswordInput({ value, onChange, placeholder="password" }){
    const [show,setShow] = useState(false);
    return (
      <div className="relative">
        <input type={show?'text':'password'} value={value} onChange={onChange}
               placeholder={placeholder} autoComplete="new-password"
               className="w-full border rounded-xl px-3 py-2 pr-10" />
        <button type="button" onClick={()=>setShow(!show)}
          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500">
          {show ? 'üôà' : 'üëÅÔ∏è'}
        </button>
      </div>
    );
  }

  /* ====== Login / Register / Forgot / ChangePass ====== */
  function Login({ onOK, onOpenRegister, onOpenForgot, onOpenChangePass }){
    const [u,setU]=useState(''), [p,setP]=useState(''), [err,setErr]=useState(''), [busy,setBusy]=useState(false);

    const submit = async(e)=>{
      e.preventDefault(); setErr(''); setBusy(true);
      try{
        // 1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô Backend
        const r = await apiLogin(u.trim(), p.trim());
        if(r.ok){
          onOK(r.user, r.history||[]);
          return;
        }
        // 2) Fallback: Admin ‡πÄ‡∏î‡πÇ‡∏°‡πà‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        if(u.trim()==='admin1959' && p.trim()==='1959'){
          const demoAdmin = { id:'SF-ADMIN', username:'admin1959', name:'‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', branch:'Head Office', role:'admin', points: 999999, tierPoints: 99999, exp: '2099-12-31' };
          onOK(demoAdmin, []);
          return;
        }
        throw new Error(r.message||'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }catch(ex){ setErr(String(ex)); } finally{ setBusy(false); }
    };

    return (
      <div className="min-h-screen grid place-items-center px-4">
        <form onSubmit={submit} className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="flex items-center gap-2 mb-3">
            <div className="h-10 w-10 rounded-2xl bg-violet-600 text-white grid place-items-center">‚òÖ</div>
            <div className="font-semibold">HRD Rewards</div>
          </div>
          <div className="text-sm text-slate-500 mb-3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ <b>username</b>/<b>password</b> ‡∏à‡∏≤‡∏Å Sheet1 (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå I, J)</div>
          <div className="space-y-3">
            <div>
              <label className="text-xs text-slate-500">username</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" autoComplete="off" value={u} onChange={e=>setU(e.target.value)} />
            </div>
            <div>
              <label className="text-xs text-slate-500">password</label>
              <div className="mt-1"><PasswordInput value={p} onChange={e=>setP(e.target.value)} /></div>
            </div>
            {err && <div className="text-sm text-rose-600">{err}</div>}
            <button className="w-full rounded-xl bg-violet-600 text-white py-2 disabled:opacity-50" disabled={busy}>
              {busy? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
            </button>
            <div className="text-sm text-center text-slate-600">
              <button type="button" className="underline mr-3" onClick={onOpenRegister}>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
              <button type="button" className="underline mr-3" onClick={onOpenForgot}>‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
              <button type="button" className="underline" onClick={onOpenChangePass}>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
            </div>
          </div>
        </form>
      </div>
    );
  }

  function Register({ onDone }){
    const initial = { employeeId:'', title:'', name:'', dob:'', email:'', username:'', password:'', password2:'' };
    const [step,setStep]=useState(1), [form,setForm]=useState(initial);
    const [exists,setExists]=useState(null); // {exists:bool, name?:string}
    const [msg,setMsg]=useState(''), [err,setErr]=useState(''), [busy,setBusy]=useState(false);

    const check = async()=>{
      setErr(''); if(!form.employeeId.trim()) return setErr('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
      const r = await apiCheckEmp(form.employeeId.trim()); setExists(r); setStep(2);
    };

    const submit = async()=>{
      setErr(''); setMsg(''); setBusy(true);
      try{
        const r = await apiRegister(form);
        if(!r.ok) throw new Error(r.message||'‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setMsg('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
        setTimeout(onDone, 1200);
      }catch(ex){ setErr(String(ex)); } finally{ setBusy(false); }
    };

    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-lg bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
          {step===1 ? (
            <div className="space-y-3">
              <div>
                <label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1"
                  value={form.employeeId} onChange={e=>setForm(f=>({...f,employeeId:e.target.value}))}/>
              </div>
              <button onClick={check} className="rounded-xl bg-violet-600 text-white px-4 py-2">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
              {err && <div className="text-sm text-rose-600">{err}</div>}
            </div>
          ) : (
            <div className="space-y-3">
              {exists?.exists ? (
                <div className="p-3 bg-emerald-50 rounded-lg text-sm">‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <b>{exists.name||form.employeeId}</b></div>
              ) : (
                <div className="p-3 bg-amber-50 rounded-lg text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</div>
              )}
              {!exists?.exists && (
                <>
                  <div><label className="text-xs text-slate-500">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1" value={form.title} onChange={e=>setForm(f=>({...f,title:e.target.value}))}/></div>
                  <div><label className="text-xs text-slate-500">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1" value={form.name} onChange={e=>setForm(f=>({...f,name:e.target.value}))}/></div>
                  <div><label className="text-xs text-slate-500">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (yyyy-mm-dd)</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1" placeholder="1990-01-31" value={form.dob} onChange={e=>setForm(f=>({...f,dob:e.target.value}))}/></div>
                </>
              )}
              <div><label className="text-xs text-slate-500">Email *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1" value={form.email} onChange={e=>setForm(f=>({...f,email:e.target.value}))}/></div>
              <div><label className="text-xs text-slate-500">‡∏ï‡∏±‡πâ‡∏á username *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1" value={form.username} onChange={e=>setForm(f=>({...f,username:e.target.value}))}/></div>
              <div><label className="text-xs text-slate-500">‡∏ï‡∏±‡πâ‡∏á password *</label>
                <div className="mt-1"><PasswordInput value={form.password} onChange={e=>setForm(f=>({...f,password:e.target.value}))}/></div></div>
              <div><label className="text-xs text-slate-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô password *</label>
                <div className="mt-1"><PasswordInput value={form.password2} onChange={e=>setForm(f=>({...f,password2:e.target.value}))}/></div></div>
              {err && <div className="text-sm text-rose-600">{err}</div>}
              {msg && <div className="text-sm text-emerald-600">{msg}</div>}
              <div className="flex gap-2">
                <button onClick={submit} className="rounded-xl bg-violet-600 text-white px-4 py-2" disabled={busy}>{busy?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‚Ä¶':'‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}</button>
                <button onClick={onDone} className="rounded-xl border px-4 py-2">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Login</button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  function Forgot({ onDone }){
    const [emp,setEmp]=useState(''), [email,setEmail]=useState(''), [msg,setMsg]=useState(''), [err,setErr]=useState('');
    const send = async()=>{
      setErr(''); setMsg('');
      try{
        const r = await apiForgot(emp.trim(), email.trim());
        if(!r.ok) throw new Error(r.message||'‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setMsg('‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
        setTimeout(onDone, 1200);
      }catch(ex){ setErr(String(ex)); }
    };
    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
          <div className="space-y-3">
            <div><label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={emp} onChange={e=>setEmp(e.target.value)} /></div>
            <div><label className="text-xs text-slate-500">Email (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå H)</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={email} onChange={e=>setEmail(e.target.value)} /></div>
            {err && <div className="text-sm text-rose-600">{err}</div>}
            {msg && <div className="text-sm text-emerald-600">{msg}</div>}
            <div className="flex gap-2">
              <button onClick={send} className="rounded-xl bg-violet-600 text-white px-4 py-2">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
              <button onClick={onDone} className="rounded-xl border px-4 py-2">‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  function ChangePass({ onDone }){
    const [emp,setEmp]=useState(''), [user,setUser]=useState(''), [oldp,setOld]=useState(''), [p1,setP1]=useState(''), [p2,setP2]=useState(''), [err,setErr]=useState(''), [msg,setMsg]=useState('');
    const submit = async()=>{
      setErr(''); setMsg('');
      if(!emp||!user||!oldp||!p1||!p2) return setErr('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
      if(p1!==p2) return setErr('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
      try{
        const r = await apiChangePass(emp.trim(), user.trim(), oldp, p1);
        if(!r.ok) throw new Error(r.message||'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); // backend ‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏¥‡∏î
        setMsg('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
        setTimeout(onDone, 1200);
      }catch(ex){ setErr(String(ex)); }
    };
    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
          <div className="space-y-3">
            <div><label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label><input className="w-full border rounded-xl px-3 py-2 mt-1" value={emp} onChange={e=>setEmp(e.target.value)} /></div>
            <div><label className="text-xs text-slate-500">Username</label><input className="w-full border rounded-xl px-3 py-2 mt-1" value={user} onChange={e=>setUser(e.target.value)} /></div>
            <div><label className="text-xs text-slate-500">Password (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)</label><div className="mt-1"><PasswordInput value={oldp} onChange={e=>setOld(e.target.value)} /></div></div>
            <div><label className="text-xs text-slate-500">Password ‡πÉ‡∏´‡∏°‡πà</label><div className="mt-1"><PasswordInput value={p1} onChange={e=>setP1(e.target.value)} /></div></div>
            <div><label className="text-xs text-slate-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Password ‡πÉ‡∏´‡∏°‡πà</label><div className="mt-1"><PasswordInput value={p2} onChange={e=>setP2(e.target.value)} /></div></div>
            {err && <div className="text-sm text-rose-600">{err}</div>}
            {msg && <div className="text-sm text-emerald-600">{msg}</div>}
            <div className="flex gap-2">
              <button onClick={submit} className="rounded-xl bg-violet-600 text-white px-4 py-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <button onClick={onDone} className="rounded-xl border px-4 py-2">‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /* ====== ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (Reward/Tasks/Announcements) ====== */
  const ITEMS = [
    { id:"R002", name:"‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Ñ", points:1200, stock:5,  tags:['‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå','premium'], img:"üíº" },
    { id:"R003", name:"‡πÅ‡∏Å‡πâ‡∏ß‡∏Å‡∏≤‡πÅ‡∏ü Tumbler", points:450, stock:8, tags:['‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ','‡∏Å‡∏≤‡πÅ‡∏ü','eco'], img:"‚òï" },
    { id:"R014", name:"‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏°‡∏∏‡∏î‡πÇ‡∏ô‡πâ‡∏ï", points:150, stock:30, tags:['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô','set'], img:"üìù" },
    { id:"R015", name:"‡∏£‡πà‡∏°‡∏û‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥", points:300, stock:20, tags:['‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ','auto','rain'], img:"‚òÇÔ∏è" },
    { id:"R016", name:"‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏õ‡πÇ‡∏• Premium", points:800, stock:15, tags:['‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤','premium'], img:"üëï" },
    { id:"R017", name:"‡∏´‡∏π‡∏ü‡∏±‡∏á Bluetooth", points:2000, stock:3, tags:['‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå','wireless','premium'], img:"üéß" },
  ];
  const TASKS = [
    { id:'T1', title:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Ñ‡∏£‡∏≠‡∏™‡∏ü‡∏¥‡∏ï 5 ‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ô', earn:100, progress:3, total:5, due:'2025-12-31' },
    { id:'T2', title:'‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', earn:200, progress:2, total:4, due:'2025-12-25' },
    { id:'T3', title:'‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏≠‡∏ö‡∏£‡∏°‡∏™‡∏±‡πâ‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', earn:150, progress:1, total:1, due:'2025-12-20' },
  ];
  const ANN = [
    { id:'A1', title:'‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏ö‡∏ô‡πÅ‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å', body:'‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∑‡∏î‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° ‡∏´‡∏π‡∏ü‡∏±‡∏á Bluetooth ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏≠‡∏¢‡∏ï‡πå', ts:'2025-12-15T07:00:00+07:00', tag:'‡∏Ç‡πà‡∏≤‡∏ß' },
    { id:'A2', title:'‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏ï‡πâ‡∏° (31 ‡∏ò.‡∏Ñ.)', body:'‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 31 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô', ts:'2025-12-10T07:00:00+07:00', tag:'‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤' },
    { id:'A3', title:'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• v2.0', body:'‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà', ts:'2025-12-01T07:00:00+07:00', tag:'‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï' },
  ];

  /* ====== UI ‡∏´‡∏•‡∏±‡∏Å (‡∏´‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô) ====== */
  function Header({ user, tab, setTab, cartCount, openCart }){
    const isAdmin = user?.role === 'admin' || user?.username === 'admin1959';
    const tabs = [
      {id:'home', label:'‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å', icon:'üè†'},
      {id:'catalog', label:'‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á', icon:'üéÅ'},
      {id:'me', label:'‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô', icon:'üèÜ'},
      {id:'history', label:'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥', icon:'üìú'},
      {id:'news', label:'‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®/‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤', icon:'üîî'},
      ...(isAdmin ? [{id:'admin', label:'Admin', icon:'‚öôÔ∏è'}] : []),
    ];
    return (
      <header className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-9 w-9 rounded-xl bg-violet-600 text-white grid place-items-center">‚òÖ</div>
            <div className="leading-tight">
              <div className="font-semibold">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
              <div className="text-xs text-slate-500">Premium Rewards</div>
            </div>
          </div>

          <nav className="hidden md:flex gap-2">
            {tabs.map(t=>(
              <button key={t.id} onClick={()=>setTab(t.id)}
                className={'px-3 py-1.5 rounded-xl text-sm border ' + (tab===t.id ? 'bg-violet-600 text-white border-violet-600' : 'bg-white hover:bg-slate-50')}>
                <span className="mr-1">{t.icon}</span>{t.label}
              </button>
            ))}
          </nav>

          <div className="flex items-center gap-2">
            <button onClick={openCart} className="relative rounded-xl border px-3 py-1.5 text-sm bg-slate-50">
              üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤{cartCount? <span className="ml-1">({cartCount})</span> : null}
            </button>
            <div className="hidden sm:block text-right mr-1">
              <div className="text-sm font-medium">{user.name}</div>
              <div className="text-xs text-slate-500">{user.id}</div>
            </div>
            <div className="h-8 w-8 rounded-full bg-slate-200 grid place-items-center">üë§</div>
          </div>
        </div>
      </header>
    );
  }

  function HomeView({ user }){
    return (
      <div className="space-y-4">
        <div className="grid sm:grid-cols-3 gap-3">
          <div className="bg-white rounded-2xl p-4 shadow">
            <div className="text-slate-500 text-sm">‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <div className="text-3xl font-bold">{fmt.format(user.points)} <span className="text-base">‡πÅ‡∏ï‡πâ‡∏°</span></div>
          </div>
          <div className="bg-white rounded-2xl p-4 shadow">
            <div className="text-slate-500 text-sm">EXP ‡∏™‡∏∞‡∏™‡∏°</div>
            <div className="text-3xl font-bold">{fmt.format(user.tierPoints)}</div>
            <div className="text-xs text-emerald-600 mt-1">+15% Multiplier</div>
          </div>
          <div className="bg-white rounded-2xl p-4 shadow">
            <div className="text-slate-500 text-sm">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î</div>
            <div className="text-3xl font-bold">{TASKS.length}</div>
          </div>
        </div>

        <section className="bg-white rounded-2xl p-4 shadow">
          <div className="font-semibold mb-3">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>
          <ul className="space-y-3">
            {TASKS.map(t=>(
              <li key={t.id} className="border rounded-xl p-3">
                <div className="flex items-center justify-between">
                  <div className="font-medium">{t.title}</div>
                  <Badge>+{t.earn} ‡πÅ‡∏ï‡πâ‡∏°</Badge>
                </div>
                <div className="mt-2 h-2 bg-slate-100 rounded-full overflow-hidden">
                  <div className="h-2 bg-violet-500" style={{width:`${Math.min(100, (t.progress/t.total)*100)}%`}}></div>
                </div>
                <div className="text-xs text-slate-500 mt-1">‡πÄ‡∏î‡∏î‡πÑ‡∏•‡∏ô‡πå: {new Date(t.due).toLocaleDateString('th-TH')} ‚Ä¢ {t.progress}/{t.total}</div>
              </li>
            ))}
          </ul>
        </section>

        <section className="bg-white rounded-2xl p-4 shadow">
          <div className="font-semibold mb-3">‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <div className="border rounded-xl p-3 bg-amber-50">{ANN[0].title} ‚Äî {ANN[0].body}</div>
        </section>
      </div>
    );
  }

  function CatalogView({ items, add }){
    const [q,setQ]=useState(''); const [sort,setSort]=useState('az'); const [cat,setCat]=useState('all');
    const cats = ['all','‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ','‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå','‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå','‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤','‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô'];
    const filtered = useMemo(()=>{
      let r = items.filter(i => (cat==='all'?true:i.tags.includes(cat)) && i.name.toLowerCase().includes(q.toLowerCase()));
      if(sort==='az') r.sort((a,b)=>a.name.localeCompare(b.name));
      if(sort==='cost') r.sort((a,b)=>a.points-b.points);
      if(sort==='stock') r.sort((a,b)=>b.stock-a.stock);
      return r;
    },[items,q,sort,cat]);
    return (
      <div>
        <div className="bg-white rounded-2xl shadow p-4 mb-4 grid gap-3 md:grid-cols-4">
          <input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." value={q} onChange={e=>setQ(e.target.value)} className="border rounded-xl px-3 py-2"/>
          <select value={cat} onChange={e=>setCat(e.target.value)} className="border rounded-xl px-3 py-2">
            {cats.map(c=><option key={c} value={c}>{c==='all'?'‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà':c}</option>)}
          </select>
          <select value={sort} onChange={e=>setSort(e.target.value)} className="border rounded-xl px-3 py-2">
            <option value="az">‡∏ä‡∏∑‡πà‡∏≠ A-Z</option>
            <option value="cost">‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πà‡∏≥‚Üí‡∏™‡∏π‡∏á</option>
            <option value="stock">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏°‡∏≤‡∏Å‚Üí‡∏ô‡πâ‡∏≠‡∏¢</option>
          </select>
          <div className="text-sm text-slate-500 self-center">{filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        </div>

        <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {filtered.map(r=>(
            <div key={r.id} className="bg-white rounded-2xl border p-4 flex flex-col shadow-sm">
              <div className="text-6xl mb-2">{r.img}</div>
              <div className="font-semibold text-lg leading-tight">{r.name}</div>
              <div className="text-sm text-slate-500 mt-1 line-clamp-2">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û</div>
              <div className="flex gap-2 mt-2 flex-wrap">
                <Badge>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {r.stock}</Badge>
                {r.tags.slice(0,3).map((t,i)=><Badge key={i}>{t}</Badge>)}
              </div>
              <div className="mt-3 text-violet-600 font-bold">‚≠ê {fmt.format(r.points)} ‡πÅ‡∏ï‡πâ‡∏°</div>
              <button onClick={()=>add(r)} disabled={r.stock<=0}
                className="mt-3 rounded-xl bg-violet-600 text-white py-2 disabled:opacity-40">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
            </div>
          ))}
        </div>
      </div>
    );
  }

  function MeView({ user, events }){
    return (
      <div className="space-y-4">
        <div className="grid sm:grid-cols-4 gap-3">
          <div className="bg-white rounded-2xl p-4 shadow"><div className="text-slate-500 text-sm">‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div className="text-3xl font-bold">{fmt.format(user.points)}</div></div>
          <div className="bg-white rounded-2xl p-4 shadow"><div className="text-slate-500 text-sm">‡πÅ‡∏ï‡πâ‡∏° Tier</div><div className="text-3xl font-bold">{fmt.format(user.tierPoints)}</div><div className="text-xs text-emerald-600">Multiplier √ó1.15</div></div>
          <div className="bg-white rounded-2xl p-4 shadow"><div className="text-slate-500 text-sm">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏ï‡πâ‡∏°</div><div className="text-3xl font-bold">{new Date(user.exp).toLocaleDateString('th-TH')}</div></div>
          <div className="bg-white rounded-2xl p-4 shadow"><div className="text-slate-500 text-sm">‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ó‡∏≥</div><div className="text-3xl font-bold">{events.filter(e=>e.type==='earn').length}</div></div>
        </div>

        <div className="bg-white rounded-2xl p-4 shadow">
          <div className="font-semibold mb-2">‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏ï‡πâ‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          <ul className="text-sm divide-y">
            {events.slice(0,8).map(e=>(
              <li key={e.id} className="py-2 flex justify-between">
                <div><b>{e.type==='earn'?'‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°':'‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á'}</b> ‚Ä¢ {e.note} <span className="text-slate-400 ml-2">{new Date(e.ts).toLocaleString('th-TH')}</span></div>
                <div className={'font-semibold ' + (e.points>0?'text-emerald-600':'text-rose-600')}>{e.points>0?`+${fmt.format(e.points)}`:fmt.format(e.points)} pts</div>
              </li>
            ))}
          </ul>
        </div>
      </div>
    );
  }

  function HistoryView({ events }){
    return (
      <div className="bg-white rounded-2xl shadow overflow-hidden">
        <table className="w-full text-sm">
          <thead className="bg-slate-50">
            <tr><th className="p-3 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th><th className="p-3 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th><th className="p-3 text-left">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th><th className="p-3 text-right">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th className="p-3 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>
          </thead>
          <tbody>
            {events.map(e=>(
              <tr key={e.id} className="border-t">
                <td className="p-3 whitespace-nowrap">{new Date(e.ts).toLocaleString('th-TH')}</td>
                <td className="p-3">{e.type==='earn'?'‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°':'‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á'}</td>
                <td className="p-3">{e.note}</td>
                <td className={'p-3 text-right font-semibold ' + (e.points>0?'text-emerald-600':'text-rose-600')}>{e.points>0?`+${fmt.format(e.points)}`:fmt.format(e.points)}</td>
                <td className="p-3">{e.status||'-'}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    );
  }

  function NewsView(){
    return (
      <div className="space-y-4">
        <section className="bg-white rounded-2xl p-4 shadow">
          <div className="font-semibold mb-2">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
          {ANN.map(a=>(
            <div key={a.id} className="border rounded-xl p-3 mb-2">
              <div className="flex items-center gap-2 mb-1"><Badge>{a.tag}</Badge><div className="font-medium">{a.title}</div></div>
              <div className="text-sm text-slate-600">{a.body}</div>
              <div className="text-xs text-slate-400 mt-1">{new Date(a.ts).toLocaleString('th-TH')}</div>
            </div>
          ))}
        </section>

        <section className="bg-white rounded-2xl p-4 shadow">
          <div className="font-semibold mb-2">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
          <ul className="space-y-2 text-sm">
            <li className="p-3 rounded-lg bg-amber-50">‚ö†Ô∏è ‡πÅ‡∏ï‡πâ‡∏°‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 31 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ</li>
            <li className="p-3 rounded-lg bg-emerald-50">‚úÖ ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 48 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</li>
            <li className="p-3 rounded-lg bg-emerald-50">‚úÖ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏™‡∏á‡∏ß‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</li>
            <li className="p-3 rounded-lg bg-amber-50">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô/‡∏Ç‡∏≤‡∏¢‡πÅ‡∏ï‡πâ‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</li>
          </ul>
        </section>
      </div>
    );
  }

  function AdminPanel({ items, setItems }){
    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô)
    const [draft,setDraft] = useState({ name:'', points:500, stock:10, tags:'premium', img:'üéÅ' });
    const addItem = ()=>{
      if(!draft.name.trim()) return;
      const newItem = { id:'R'+Math.random().toString(36).slice(2,6).toUpperCase(), name:draft.name.trim(), points:Number(draft.points)||1, stock:Number(draft.stock)||0, tags:draft.tags.split(',').map(s=>s.trim()).filter(Boolean), img:draft.img||'üéÅ' };
      setItems(prev=>[newItem,...prev]); setDraft({ name:'', points:500, stock:10, tags:'premium', img:'üéÅ' });
    };
    return (
      <div className="space-y-4">
        <div className="grid sm:grid-cols-4 gap-3">
          <div className="bg-white rounded-2xl p-4 shadow"><div className="text-slate-500 text-sm">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div className="text-3xl font-bold">{items.length}</div></div>
          <div className="bg-white rounded-2xl p-4 shadow"><div className="text-slate-500 text-sm">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏ß‡∏°</div><div className="text-3xl font-bold">{fmt.format(items.reduce((s,i)=>s+i.stock,0))}</div></div>
          <div className="bg-white rounded-2xl p-4 shadow"><div className="text-slate-500 text-sm">‡πÅ‡∏ï‡πâ‡∏°‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div><div className="text-3xl font-bold">{fmt.format(Math.round(items.reduce((s,i)=>s+i.points,0)/items.length))}</div></div>
          <div className="bg-white rounded-2xl p-4 shadow"><div className="text-slate-500 text-sm">‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</div><div className="mt-2 text-sm text-slate-600">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡∏° ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πâ‡∏°-‡∏™‡∏ï‡πá‡∏≠‡∏Å</div></div>
        </div>

        <div className="bg-white rounded-2xl p-4 shadow">
          <div className="font-semibold mb-2">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
          <div className="grid md:grid-cols-5 gap-2">
            <input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡∏°" className="border rounded-xl px-3 py-2" value={draft.name} onChange={e=>setDraft(d=>({...d,name:e.target.value}))}/>
            <input type="number" placeholder="‡πÅ‡∏ï‡πâ‡∏°" className="border rounded-xl px-3 py-2" value={draft.points} onChange={e=>setDraft(d=>({...d,points:e.target.value}))}/>
            <input type="number" placeholder="‡∏™‡∏ï‡πá‡∏≠‡∏Å" className="border rounded-xl px-3 py-2" value={draft.stock} onChange={e=>setDraft(d=>({...d,stock:e.target.value}))}/>
            <input placeholder="tags ‡∏Ñ‡∏±‡πà‡∏ô , " className="border rounded-xl px-3 py-2" value={draft.tags} onChange={e=>setDraft(d=>({...d,tags:e.target.value}))}/>
            <input placeholder="‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥" className="border rounded-xl px-3 py-2" value={draft.img} onChange={e=>setDraft(d=>({...d,img:e.target.value}))}/>
          </div>
          <button onClick={addItem} className="mt-3 rounded-xl bg-violet-600 text-white px-4 py-2">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>

        <div className="bg-white rounded-2xl p-4 shadow">
          <div className="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
          <table className="w-full text-sm">
            <thead className="bg-slate-50"><tr><th className="p-2 text-left">‡∏ä‡∏∑‡πà‡∏≠</th><th className="p-2 text-right">‡πÅ‡∏ï‡πâ‡∏°</th><th className="p-2 text-right">‡∏™‡∏ï‡πá‡∏≠‡∏Å</th><th className="p-2">‡πÅ‡∏ó‡πá‡∏Å</th><th className="p-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
            <tbody>
              {items.map(it=>(
                <tr key={it.id} className="border-t">
                  <td className="p-2">{it.img} {it.name}</td>
                  <td className="p-2 text-right">{fmt.format(it.points)}</td>
                  <td className="p-2 text-right">{fmt.format(it.stock)}</td>
                  <td className="p-2">{it.tags.slice(0,2).map((t,i)=><Badge key={i}>{t}</Badge>)}</td>
                  <td className="p-2">
                    <button className="px-2 py-1 rounded-lg border mr-1" onClick={()=>setItems(prev=>prev.map(x=>x.id===it.id?{...x,stock:x.stock+1}:x))}>‚ûï‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                    <button className="px-2 py-1 rounded-lg border mr-1" onClick={()=>setItems(prev=>prev.map(x=>x.id===it.id?{...x,stock:Math.max(0,x.stock-1)}:x))}>‚ûñ‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                    <button className="px-2 py-1 rounded-lg border text-rose-600" onClick={()=>setItems(prev=>prev.filter(x=>x.id!==it.id))}>üóë ‡∏•‡∏ö</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div className="text-xs text-slate-500">* ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ä‡∏µ‡∏ï‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å <code>adminSaveConfig</code> ‡∏ù‡∏±‡πà‡∏á Apps Script</div>
      </div>
    );
  }

  function CheckoutModal({ open, onClose, user, cart, setItems, setUser }){
    if(!open) return null;
    const total = cart.reduce((s,c)=> s + c.points*c.qty, 0);
    const checkout = async ()=>{
      try{
        const note = cart.map(c=>`${c.name} x${c.qty}`).join(', ');
        const r = await apiRedeem(user.id, total, note);
        if(!r.ok) throw new Error(r.message||'‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        const fresh = await apiGetPoints(user.id);
        setUser(u=>({...u, points:fresh.points}));
      }catch(ex){ alert('‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+ex); return; }
      setItems(prev=>prev.map(it=>{
        const c = cart.find(x=>x.id===it.id);
        if(!c) return it;
        return {...it, stock:Math.max(0,it.stock-c.qty)};
      }));
      onClose(true);
    };
    return (
      <div className="fixed inset-0 z-30 bg-black/40 grid place-items-center p-4">
        <div className="w-full max-w-2xl bg-white rounded-2xl shadow-lg">
          <div className="flex items-center justify-between p-4 border-b"><div className="font-semibold">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</div><button onClick={()=>onClose(false)} className="rounded-full w-8 h-8 grid place-items-center border">‚úï</button></div>
          <div className="p-4 max-h-[60vh] overflow-auto">
            {cart.length===0 ? <div className="text-center text-slate-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div> :
            <ul className="space-y-3">
              {cart.map(c=>(
                <li key={c.id} className="flex items-center gap-3 border rounded-xl p-3">
                  <div className="text-2xl">{c.img}</div>
                  <div className="flex-1">
                    <div className="font-medium">{c.name}</div>
                    <div className="text-xs text-slate-500">{c.points} pts</div>
                  </div>
                  <div className="w-24 text-right font-semibold">{fmt.format(c.points*c.qty)} pts</div>
                </li>
              ))}
            </ul>}
          </div>
          <div className="p-4 border-t flex items-center justify-between">
            <div className="text-sm text-slate-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏∏‡∏ì: <b>{fmt.format(user.points)} pts</b></div>
            <div className="text-right"><div className="text-sm">‡∏£‡∏ß‡∏°‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</div><div className="text-xl font-bold">{fmt.format(total)} pts</div></div>
          </div>
          <div className="p-4 border-t text-right">
            <button onClick={checkout} disabled={cart.length===0 || total>user.points} className="rounded-xl px-4 py-2 bg-violet-600 text-white disabled:opacity-50">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å</button>
          </div>
        </div>
      </div>
    );
  }

  /* ====== ‡πÅ‡∏≠‡∏õ‡∏´‡∏•‡∏±‡∏Å ====== */
  function App(){
    const [mode,setMode] = useState('login'); // login | register | forgot | changepw | app
    const [tab,setTab] = useState('home');
    const [user,setUser]=useState(null);
    const [items,setItems]=useState(ITEMS);
    const [cart,setCart]=useState([]);
    const [events,setEvents]=useState([]);
    const [openCart,setOpenCart]=useState(false);

    if(mode==='login')     return <Login onOK={(u)=>{ setUser(u); setMode('app'); }} onOpenRegister={()=>setMode('register')} onOpenForgot={()=>setMode('forgot')} onOpenChangePass={()=>setMode('changepw')} />;
    if(mode==='register')  return <Register onDone={()=>setMode('login')} />;
    if(mode==='forgot')    return <Forgot onDone={()=>setMode('login')} />;
    if(mode==='changepw')  return <ChangePass onDone={()=>setMode('login')} />;

    const addToCart = (r)=> setCart(prev=>{ const has=prev.find(x=>x.id===r.id); if(has) return prev.map(x=>x.id===r.id?{...x,qty:Math.min(x.qty+1,r.stock)}:x); return [...prev,{...r,qty:1}]});
    const isAdmin = user?.role==='admin' || user?.username==='admin1959';

    return (
      <div>
        <Header user={user} tab={tab} setTab={setTab} cartCount={cart.reduce((s,c)=>s+c.qty,0)} openCart={()=>setOpenCart(true)} />

        <main className="max-w-6xl mx-auto px-4 py-6">
          {tab==='home'    && <HomeView user={user} />}
          {tab==='catalog' && <CatalogView items={items} add={addToCart} />}
          {tab==='me'      && <MeView user={user} events={events} />}
          {tab==='history' && <HistoryView events={events} />}
          {tab==='news'    && <NewsView />}
          {tab==='admin'   && (isAdmin ? <AdminPanel items={items} setItems={setItems} /> : <div className="text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</div>)}
        </main>

        <CheckoutModal open={openCart} onClose={(ok)=>{ setOpenCart(false); if(ok){ setEvents(prev=>[{ id:'ORD-'+Date.now(), type:'redeem', ts:new Date().toISOString(), note: cart.map(c=>`${c.name} x${c.qty}`).join(', '), points: -cart.reduce((s,c)=>s+c.points*c.qty,0), status:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°' },...prev]); setCart([]);} }} user={user} cart={cart} setItems={setItems} setUser={setUser} />
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
