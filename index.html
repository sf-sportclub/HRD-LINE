<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HRD Rewards</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body{background:#f1f5f9}</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState } = React;
  const fmt = new Intl.NumberFormat('th-TH');

  /* ====== URL Apps Script /exec ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ====== */
  const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwcYfT0NxBSGphJw8U8JUFashnZXlLrfWaJE8-gfF6787zR-VUxv2If8ccLICn4f7NToQ/exec'; // <-- ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

  /* ====== fetch ‡πÅ‡∏ö‡∏ö simple request (‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á preflight) ====== */
  async function callApi(action, payload) {
    const res = await fetch(WEBAPP_URL, {
      method: 'POST',
      body: JSON.stringify({ action, payload }), // text/plain ‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏¥‡∏¢‡∏≤‡∏¢
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { return { ok:false, message:'Bad JSON from server', raw:text }; }
  }

  // === API adapters ===
  const apiLogin      = (u,p)             => callApi('login',        { username:u, password:p });
  const apiGetPoints  = (id)              => callApi('getPoints',    { employeeId:id });
  const apiRedeem     = (id,amt,note)     => callApi('redeem',       { employeeId:id, amount:amt, note });
  const apiCheckEmp   = (id)              => callApi('checkEmployee',{ employeeId:id });
  const apiRegister   = (pl)              => callApi('register',     pl);
  const apiForgot     = (id,email)        => callApi('forgot',       { employeeId:id, email });
  const apiChangePass = (id,u,oldp,newp)  => callApi('changePassword',{ employeeId:id, username:u, oldPassword:oldp, newPassword:newp });

  /* ====== UI Reusable ====== */
  function PasswordInput({ value, onChange, placeholder="password" }){
    const [show,setShow] = useState(false);
    return (
      <div className="relative">
        <input type={show?'text':'password'} value={value} onChange={onChange}
               placeholder={placeholder} autoComplete="new-password"
               className="w-full border rounded-xl px-3 py-2 pr-10" />
        <button type="button" onClick={()=>setShow(!show)}
          className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500">
          {show ? 'üôà' : 'üëÅÔ∏è'}
        </button>
      </div>
    );
  }

  /* ====== Auth Screens ====== */
  function Login({ onOK, onOpenRegister, onOpenForgot, onOpenChangePass }){
    const [u,setU]=useState(''), [p,setP]=useState(''), [err,setErr]=useState(''), [busy,setBusy]=useState(false);
    const submit = async(e)=>{
      e.preventDefault(); setErr(''); setBusy(true);
      try{
        const r = await apiLogin(u.trim(), p.trim());
        if(!r.ok) throw new Error(r.message||'‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        onOK(r.user, r.history||[]);
      }catch(ex){ setErr(String(ex)); } finally{ setBusy(false); }
    };
    return (
      <div className="min-h-screen grid place-items-center px-4">
        <form onSubmit={submit} className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="flex items-center gap-2 mb-3">
            <div className="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center">SF</div>
            <div className="font-semibold">HRD Rewards</div>
          </div>
        <div className="text-sm text-slate-500 mb-3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ <b>username</b> / <b>password</b> ‡∏à‡∏≤‡∏Å Sheet1 (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå I,J)</div>
          <div className="space-y-3">
            <div>
              <label className="text-xs text-slate-500">username</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" autoComplete="off"
                     value={u} onChange={e=>setU(e.target.value)} />
            </div>
            <div>
              <label className="text-xs text-slate-500">password</label>
              <div className="mt-1"><PasswordInput value={p} onChange={e=>setP(e.target.value)} /></div>
            </div>
            {err && <div className="text-sm text-rose-600">{err}</div>}
            <button className="w-full rounded-xl bg-slate-900 text-white py-2 disabled:opacity-50" disabled={busy}>
              {busy? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...' : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}
            </button>
            <div className="text-sm text-center text-slate-600">
              <button type="button" className="underline mr-3" onClick={onOpenRegister}>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
              <button type="button" className="underline mr-3" onClick={onOpenForgot}>‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
              <button type="button" className="underline" onClick={onOpenChangePass}>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
            </div>
          </div>
        </form>
      </div>
    );
  }

  function Register({ onDone }){
    const initialForm = { employeeId:'', title:'', name:'', dob:'', email:'', username:'', password:'', password2:'' };
    const [step,setStep] = useState(1);
    const [checking,setChecking] = useState(false);
    const [existsInfo,setExistsInfo] = useState(null);
    const [form,setForm] = useState(initialForm);
    const [err,setErr] = useState('');
    const [okMsg,setOkMsg] = useState('');
    const [busy,setBusy] = useState(false);

    const resetAll = () => { setStep(1); setChecking(false); setExistsInfo(null); setForm(initialForm); setErr(''); setOkMsg(''); };
    const goBackToLogin = () => { resetAll(); onDone(); };

    const check = async()=>{
      setErr('');
      if(!form.employeeId.trim()) { setErr('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); return; }
      setChecking(true);
      try{
        const r = await apiCheckEmp(form.employeeId.trim());
        setExistsInfo(r);
        setForm(f=>({ ...f, email:'', username:'', password:'', password2:'' })); // ‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á
        setStep(2);
      }catch(ex){ setErr(String(ex)); } finally{ setChecking(false); }
    };

    const submit = async()=>{
      setErr(''); setOkMsg(''); setBusy(true);
      try{
        const r = await apiRegister(form);
        if(!r.ok) throw new Error(r.message||'‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setOkMsg('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
        setTimeout(()=> { goBackToLogin(); }, 1200);  // ‚Üê ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      }catch(ex){ setErr(String(ex)); } finally { setBusy(false); }
    };

    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-lg bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>

          {step===1 && (
            <div className="space-y-3">
              <div>
                <label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1"
                  value={form.employeeId}
                  onChange={e=>setForm(f=>({ ...f, employeeId:e.target.value, password:'', password2:'', username:'', email:'' }))}/>
              </div>
              <button className="rounded-xl bg-slate-900 text-white px-4 py-2" onClick={check} disabled={checking}>
                {checking? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‡∏ñ‡∏±‡∏î‡πÑ‡∏õ'}
              </button>
              {err && <div className="text-sm text-rose-600">{err}</div>}
              <button className="text-sm underline mt-2" onClick={goBackToLogin}>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
          )}

          {step===2 && (
            <div className="space-y-3">
              {existsInfo?.exists ? (
                <div className="p-3 bg-emerald-50 rounded-lg text-sm">
                  ‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: <b>{existsInfo.name||form.employeeId}</b><br/>
                  ‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á username / password ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
                </div>
              ) : (
                <div className="p-3 bg-amber-50 rounded-lg text-sm">
                  ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡πâ‡∏á username / password
                </div>
              )}

              <div className="text-right -mt-2 mb-1">
                <button className="text-xs underline" onClick={resetAll}>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
              </div>

              {!existsInfo?.exists && (
                <>
                  <div>
                    <label className="text-xs text-slate-500">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1" autoComplete="off"
                      value={form.title} onChange={e=>setForm(f=>({...f,title:e.target.value}))}/>
                  </div>
                  <div>
                    <label className="text-xs text-slate-500">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1" autoComplete="off"
                      value={form.name} onChange={e=>setForm(f=>({...f,name:e.target.value}))}/>
                  </div>
                  <div>
                    <label className="text-xs text-slate-500">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î (yyyy-mm-dd)</label>
                    <input className="w-full border rounded-xl px-3 py-2 mt-1" placeholder="1990-01-31" autoComplete="off"
                      value={form.dob} onChange={e=>setForm(f=>({...f,dob:e.target.value}))}/>
                  </div>
                </>
              )}

              <div>
                <label className="text-xs text-slate-500">Email (‡πÉ‡∏ä‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™) *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1" autoComplete="off"
                  value={form.email} onChange={e=>setForm(f=>({...f,email:e.target.value}))}/>
              </div>
              <div>
                <label className="text-xs text-slate-500">‡∏ï‡∏±‡πâ‡∏á username *</label>
                <input className="w-full border rounded-xl px-3 py-2 mt-1" autoComplete="off"
                  value={form.username} onChange={e=>setForm(f=>({...f,username:e.target.value}))}/>
              </div>
              <div>
                <label className="text-xs text-slate-500">‡∏ï‡∏±‡πâ‡∏á password *</label>
                <div className="mt-1"><PasswordInput value={form.password} onChange={e=>setForm(f=>({...f,password:e.target.value}))}/></div>
              </div>
              <div>
                <label className="text-xs text-slate-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô password *</label>
                <div className="mt-1"><PasswordInput value={form.password2} onChange={e=>setForm(f=>({...f,password2:e.target.value}))}/></div>
              </div>

              {err && <div className="text-sm text-rose-600">{err}</div>}
              {okMsg && <div className="text-sm text-emerald-600">{okMsg}</div>}

              <div className="flex gap-2">
                <button className="rounded-xl bg-slate-900 text-white px-4 py-2" onClick={submit} disabled={busy}>
                  {busy?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‚Ä¶':'‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å'}
                </button>
                <button className="rounded-xl border px-4 py-2" onClick={resetAll}>‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button className="text-sm underline ml-auto" onClick={goBackToLogin}>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
              </div>
            </div>
          )}
        </div>
      </div>
    );
  }

  function Forgot({ onDone }){
    const [emp,setEmp]=useState(''), [email,setEmail]=useState(''), [msg,setMsg]=useState(''), [err,setErr]=useState(''), [busy,setBusy]=useState(false);
    const submit = async()=>{
      setErr(''); setMsg(''); setBusy(true);
      try{
        const r = await apiForgot(emp.trim(), email.trim());
        if(!r.ok) throw new Error(r.message||'‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setMsg('‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
        setTimeout(()=> onDone(), 1200); // ‚Üê ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login
      }catch(ex){ setErr(String(ex)); } finally{ setBusy(false); }
    };
    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
          <div className="space-y-3">
            <div>
              <label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={emp} onChange={e=>setEmp(e.target.value)} />
            </div>
            <div>
              <label className="text-xs text-slate-500">Email (‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå H)</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={email} onChange={e=>setEmail(e.target.value)} />
            </div>
            {err && <div className="text-sm text-rose-600">{err}</div>}
            {msg && <div className="text-sm text-emerald-600">{msg}</div>}
            <div className="flex gap-2">
              <button className="rounded-xl bg-slate-900 text-white px-4 py-2" onClick={submit} disabled={busy}>
                {busy?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...':'‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠'}
              </button>
              <button className="rounded-xl border px-4 py-2" onClick={onDone}>‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /* ===== ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ===== */
  function ChangePassword({ onDone }) {
    const [emp,setEmp] = useState('');
    const [user,setUser] = useState('');
    const [oldp,setOldp] = useState('');
    const [p1,setP1] = useState('');
    const [p2,setP2] = useState('');
    const [err,setErr] = useState('');
    const [msg,setMsg] = useState('');
    const [busy,setBusy] = useState(false);

    const submit = async ()=>{
      setErr(''); setMsg('');
      if(!emp || !user || !oldp || !p1 || !p2){ setErr('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á'); return; }
      if(p1 !== p2){ setErr('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'); return; }
      if(p1.length < 6){ setErr('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'); return; }
      setBusy(true);
      try{
        const r = await apiChangePass(emp.trim(), user.trim(), oldp, p1);
        if(!r.ok) throw new Error(r.message||'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        setMsg('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‚Ä¶');
        setTimeout(()=> onDone(), 1200); // ‚Üê ‡πÄ‡∏î‡πâ‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Login
      }catch(ex){ setErr(String(ex)); } finally{ setBusy(false); }
    };

    return (
      <div className="min-h-screen grid place-items-center px-4">
        <div className="w-full max-w-md bg-white rounded-2xl shadow p-6">
          <div className="font-semibold mb-3">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</div>
          <div className="text-xs text-slate-500 mb-3">‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á ‚ÄúPassword (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)‚Äù</div>
          <div className="space-y-3">
            <div><label className="text-xs text-slate-500">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={emp} onChange={e=>setEmp(e.target.value)} /></div>
            <div><label className="text-xs text-slate-500">Username</label>
              <input className="w-full border rounded-xl px-3 py-2 mt-1" value={user} onChange={e=>setUser(e.target.value)} /></div>
            <div><label className="text-xs text-slate-500">Password (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)</label>
              <div className="mt-1"><PasswordInput value={oldp} onChange={e=>setOldp(e.target.value)} /></div></div>
            <div><label className="text-xs text-slate-500">Password ‡πÉ‡∏´‡∏°‡πà</label>
              <div className="mt-1"><PasswordInput value={p1} onChange={e=>setP1(e.target.value)} /></div></div>
            <div><label className="text-xs text-slate-500">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Password ‡πÉ‡∏´‡∏°‡πà</label>
              <div className="mt-1"><PasswordInput value={p2} onChange={e=>setP2(e.target.value)} /></div></div>

            {err && <div className="text-sm text-rose-600">{err}</div>}
            {msg && <div className="text-sm text-emerald-600">{msg}</div>}

            <div className="flex gap-2">
              <button className="rounded-xl bg-slate-900 text-white px-4 py-2 disabled:opacity-50"
                      onClick={submit} disabled={busy}>{busy?'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...':'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™'}</button>
              <button className="rounded-xl border px-4 py-2" onClick={onDone}>‡∏Å‡∏•‡∏±‡∏ö</button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  /* ====== App (‡∏´‡∏•‡∏±‡∏Å) ‚Äî ‡πÅ‡∏Ñ‡∏ï‡∏ï‡∏≤‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏î‡πÇ‡∏° + ‡πÅ‡∏•‡∏Å‡πÅ‡∏ï‡πâ‡∏° ====== */
  const ITEMS = [
    { id:"R002", name:"‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏¢‡∏∑‡∏î SF Sport Club", points:700, stock:24, img:"üëï" },
    { id:"R003", name:"‡∏ú‡πâ‡∏≤‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏ã‡πá‡∏ï 3 ‡∏ú‡∏∑‡∏ô",   points:550, stock:42, img:"üßº" },
    { id:"R008", name:"‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏¥‡∏á‡∏õ‡∏≠‡∏á (‡πÑ‡∏°‡πâ+‡∏•‡∏π‡∏Å)",  points:900, stock:10, img:"üèì" },
    { id:"R011", name:"‡πÅ‡∏Å‡πâ‡∏ß‡∏ô‡πâ‡∏≥‡∏™‡πÅ‡∏ï‡∏ô‡πÄ‡∏•‡∏™ 20oz",   points:600, stock:30, img:"ü•§" },
    { id:"R012", name:"‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÇ‡∏õ‡πÇ‡∏• SF (Limited)", points:1100,stock:15, img:"üß•" },
    { id:"R013", name:"‡∏´‡∏°‡∏ß‡∏Å‡πÅ‡∏Å‡πä‡∏õ SF",            points:400, stock:40, img:"üß¢" },
    { id:"R014", name:"‡∏ñ‡∏∏‡∏á‡∏ú‡πâ‡∏≤‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏° + ‡πÄ‡∏Ç‡πá‡∏°‡∏Å‡∏•‡∏±‡∏î", points:450, stock:50, img:"üëú" },
  ];

  function Header({ user, cartCount, onLogout, openCart }){
    return (
      <header className="bg-white border-b">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center">SF</div>
            <div className="leading-tight">
              <div className="font-semibold">HRD Rewards</div>
              <div className="text-xs text-slate-500">Wellness & Happy Workplace</div>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <div className="hidden sm:block text-right mr-2">
              <div className="text-sm font-medium">{user.name}</div>
              <div className="text-xs text-slate-500">{user.id}</div>
            </div>
            <button onClick={openCart} className="relative rounded-xl border px-3 py-1.5 text-sm bg-slate-50">
              üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤{cartCount? <span className="ml-1">({cartCount})</span> : null}
            </button>
            <button onClick={onLogout} className="rounded-xl border px-3 py-1.5 text-sm bg-slate-50">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>
        </div>
      </header>
    );
  }

  function CheckoutModal({ open, onClose, user, cart, items, setItems, setUser }){
    if(!open) return null;
    const total = cart.reduce((s,c)=> s + c.points*c.qty, 0);

    const doCheckout = async ()=>{
      try{
        const note = cart.map(c=>`${c.name} x${c.qty}`).join(', ');
        const r = await apiRedeem(user.id, total, note);
        if(!r.ok) throw new Error(r.message||'‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πâ‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        const fresh = await apiGetPoints(user.id);
        setUser(u=>({...u, points: fresh.points}));
      }catch(ex){
        alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πâ‡∏°: '+ex);
        return;
      }
      setItems(prev=> prev.map(it=>{
        const c = cart.find(x=>x.id===it.id);
        if(!c) return it;
        return {...it, stock: Math.max(0, it.stock - c.qty)};
      }));
      onClose(true); // ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    };

    return (
      <div className="fixed inset-0 z-30 bg-black/40 grid place-items-center p-4">
        <div className="w-full max-w-2xl bg-white rounded-2xl shadow-lg">
          <div className="flex items-center justify-between p-4 border-b">
            <div className="font-semibold">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</div>
            <button onClick={()=>onClose(false)} className="rounded-full w-8 h-8 grid place-items-center border">‚úï</button>
          </div>
          <div className="p-4 max-h-[60vh] overflow-auto">
            {cart.length===0 ? <div className="text-center text-slate-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div> :
              <ul className="space-y-3">
                {cart.map(c=>(
                  <li key={c.id} className="flex items-center gap-3 border rounded-xl p-3">
                    <div className="text-2xl">{c.img}</div>
                    <div className="flex-1">
                      <div className="font-medium">{c.name}</div>
                      <div className="text-xs text-slate-500">{c.points} pts</div>
                    </div>
                    <div className="w-24 text-right font-semibold">{fmt.format(c.points*c.qty)} pts</div>
                  </li>
                ))}
              </ul>
            }
          </div>
          <div className="p-4 border-t flex items-center justify-between">
            <div className="text-sm text-slate-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏∏‡∏ì: <b>{fmt.format(user.points)} pts</b></div>
            <div className="text-right">
              <div className="text-sm">‡∏£‡∏ß‡∏°‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°</div>
              <div className="text-xl font-bold">{fmt.format(total)} pts</div>
            </div>
          </div>
          <div className="p-4 border-t text-right">
            <button className="rounded-xl px-4 py-2 bg-slate-900 text-white disabled:opacity-50"
                    disabled={cart.length===0 || total>user.points}
                    onClick={doCheckout}>
              ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏Å
            </button>
          </div>
        </div>
      </div>
    );
  }

  function App(){
    const [mode,setMode] = useState('login');          // login | register | forgot | changepw | app
    const [registerKey,setRegisterKey] = useState(0);  // force-remount Register
    const [user,setUser]=useState(null);
    const [items,setItems]=useState(ITEMS);
    const [cart,setCart]=useState([]);
    const [openCart,setOpenCart]=useState(false);

    if(mode==='login') return (
      <Login
        onOK={(u)=>{ setUser(u); setMode('app'); }}
        onOpenRegister={()=>{ setRegisterKey(k=>k+1); setMode('register'); }}
        onOpenForgot={()=>setMode('forgot')}
        onOpenChangePass={()=>setMode('changepw')}
      />
    );
    if(mode==='register') return <Register key={registerKey} onDone={()=>setMode('login')} />;
    if(mode==='forgot')   return <Forgot onDone={()=>setMode('login')} />;
    if(mode==='changepw') return <ChangePassword onDone={()=>setMode('login')} />;

    return (
      <div>
        <Header user={user} cartCount={cart.reduce((s,c)=>s+c.qty,0)}
                onLogout={()=>{ setMode('login'); setUser(null); setCart([]); }}
                openCart={()=>setOpenCart(true)} />

        <main className="max-w-6xl mx-auto px-4 py-6">
          <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
            {items.map(r=>(
              <div key={r.id} className="rounded-2xl border p-4 flex flex-col">
                <div className="flex items-center gap-3">
                  <div className="text-3xl">{r.img}</div>
                  <div className="flex-1">
                    <div className="font-medium">{r.name}</div>
                    <div className="text-xs text-slate-500 mt-1 flex gap-2">
                      <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs">{r.points} pts</span>
                      <span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs">‡∏™‡∏ï‡πá‡∏≠‡∏Å {r.stock}</span>
                    </div>
                  </div>
                </div>
                <button onClick={()=>{
                  setCart(prev=>{
                    const has = prev.find(x=>x.id===r.id);
                    if(has) return prev.map(x=> x.id===r.id ? {...x, qty:Math.min(x.qty+1, r.stock)} : x);
                    return [...prev, {...r, qty:1}];
                  });
                }} disabled={r.stock<=0}
                className="mt-3 rounded-xl px-3 py-2 text-sm bg-slate-900 text-white disabled:opacity-40">
                  {r.stock>0? '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤' : '‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'}
                </button>
              </div>
            ))}
          </div>
        </main>

        <CheckoutModal open={openCart} onClose={(ok)=>{ setOpenCart(false); if(ok) setCart([]); }}
          user={user} cart={cart} items={items} setItems={setItems} setUser={setUser} />
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
